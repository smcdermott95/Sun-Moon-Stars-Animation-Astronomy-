<!DOCTYPE html>
<html>
  <head>
    <script src="https://rawgit.com/mourner/suncalc/master/suncalc.js" type="text/javascript">
    </script>
    <script src="moment-with-locales.js" type="text/javascript">
    </script>

    <title>unnamed App</title>
    <script>

    //set the start location to new york city, NY
    function tempStartLocation()
    {
      document.getElementById("latDeg").value=40;
      document.getElementById("latMin").value=43;
      document.getElementById("lonDeg").value=74;
      document.getElementById("lonMin").value=0;
      document.getElementById("timezone").value=-5;
    }



    //convert altitude angle(-30 to +90) to pixel y-coordinate on the canvas
    function yCoord(coord)
    {
      var c = document.getElementById("myCanvas");
      return -c.height*.75/90*coord+.75*c.height;
    }
    //convert the azimuth angle (0 to 360 degrees east of north) to
    //an x-coordinate on the canvas
    function xCoord(coord)
    {
      var c = document.getElementById("myCanvas");
      return coord/360*c.width;
    }



    /*
    This function will enable or disable the am/pm drop-down selection
    if the user changes the clock type to or from 12 to 24 hour.
    This function will convert the time drop-down boxes to 12hr or 24hr format
    if the user changes the clock type to or from 12 to 24 hour.
    */
    function updateClockType()
    {
      //grab the hour selection box
      var hourDropDown=document.getElementById("hour");

      //grab the selected hour on page
      var hour=document.getElementById("hour").value;

      //check which clock type is selected(12 or 24)
      if(checkClockType()=="12")
      {
        //if clock type is 12 enable the am/pm selection box
        document.getElementById("ampm").disabled=false;

        //delete options from hour selection box
        for(var i=hourDropDown.length; i>=0; i--)
        {
          hourDropDown.remove(i);
        }

        //create 12am/12pm option and add to hour selection
        var option = document.createElement("option");
        option.value="12";
        option.text="12";
        hourDropDown.add(option);

        //create 1-11am/pm options and add to hour selection
        for(var i=1; i<=11; i++)
        {
          option = document.createElement("option");
          option.value=i;
          option.text=i;
          hourDropDown.add(option);
        }

        //create a moment using the selected hour and convert to 12 hour format
        var hourMoment=moment(hour,"HH");
        document.getElementById("hour").value=parseInt(hourMoment.clone().format("hh"));
        document.getElementById("ampm").value=hourMoment.format("a").charAt(0);
      }
      else
      {
        //if clock type is 24 disable the am/pm selection box
        document.getElementById("ampm").disabled=true;

        //delete options from hour selection box
        for(var i=hourDropDown.length; i>=0; i--)
        {
          hourDropDown.remove(i);
        }

        //create 0-23 hour options and add to hour selection
        var option;
        for(var i=0; i<=23; i++)
        {
          option = document.createElement("option");
          option.value=i;
          option.text =i;
          hourDropDown.add(option);
        }

        //create a moment from the selected hour and selected am/pm
        //and convert to 24 hour format.
        var hourMoment=moment(hour+" "+document.getElementById("ampm").value,"hh a");
        document.getElementById("hour").value=parseInt(hourMoment.clone().format("HH"));
      }
    }



    //This function will determine which radio button for clock
    //type (12 or 24) is checked and return
    function checkClockType() {
      if(document.getElementById("clockType12").checked) {
        return "12";
      }
      else {
        return "24";
      }
    }




    /*
    This function will update the day selection options (0-31) if the user
    changes the month selection.
    The var yesUpdate is a boolean. If true, drawCanvas() will be called to
    update the HTML canbas
    */
    function handleMonthChange(yesUpdate) {
      var day=document.getElementById("day").value;
      var month=document.getElementById("month").value;
      var year=document.getElementById("year").value;

      var daysInMonth=moment(month+"-"+year, "MM-YYYY").daysInMonth();

      var dayDropDown=document.getElementById("day");

      //delete options from day selection box
      for(var i=dayDropDown.length; i>=0; i--)
      {
        dayDropDown.remove(i);
      }

      //create 0-daysInMonth options in day selection drop-down
      //each option represents a date in a month
      var option;
      for(var i=1; i<=daysInMonth; i++)
      {
        option = document.createElement("option");
        option.value =i;
        option.text =i;
        dayDropDown.add(option);
      }

      //if the date is greater than the number of days
      //in updated month then set the day to the highest date in month
      if(day>daysInMonth)
      {
        day=daysInMonth;
      }
      document.getElementById("day").value=day;

      //update the canvas if true
      if(yesUpdate)
      {
      drawCanvas();
      }
    }




    /*
    This function will draw the moon with a given JS Date object,
    a latitude and longitude.
    */
    function drawMoon(timeAndDate,latitude, longitude)
    {
      //calculate moon alitude and azimuth
      var moonPos=SunCalc.getMoonPosition(/*Date*/ timeAndDate, /*Number*/ latitude, /*Number*/ longitude);
      var moonAltitude=moonPos.altitude*180/Math.PI;
      var moonAzimuth=moonPos.azimuth*180/Math.PI+180;

      //adjustment for southern hemisphere, TODO NEEDS TO BE FIXED
      if(latitude<0)
      {
        moonAzimuth=(moonAzimuth+180)%360;
      }

      //draw moon on canvas
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.beginPath();
      ctx.arc(xCoord(moonAzimuth),yCoord(moonAltitude),8,0,2*Math.PI);
      ctx.strokeStyle = '#990000';
      ctx.stroke();
      ctx.fillStyle = '#ffffff';
      ctx.fill();
      ctx.closePath();
    }



    /*
    This function calculates and plots red dots/circles for every hour (0-23)
    indicating where the sun is at the beginning of each hour HH:00
    */
    function plotSunPoints(latitude, longitude, momentIn)
    {
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");

      //A moment counter that will be incremented every hour
      var momentCounter=moment(momentIn.clone().format("MM/DD/YYYY"),"MM/DD/YYYY");

      //JS Date object require for SunCalc library
      var timeAndDate;

      //Used to Altitude and Azimuth of the sun at the beginning of an hour
      var sunHourAltitude, sunHourAzimuth;

      //Loop through every hour
      for(count=0;count<=23; count++)
      {
        //Convert moment object to JS Date
        timeAndDate=momentCounter.clone().toDate();

        //Calculate altitude and azimuth
        var sunPos=SunCalc.getPosition(/*Date*/ timeAndDate, /*Number*/ latitude, /*Number*/ longitude);
        sunHourAltitude=sunPos.altitude*180/Math.PI;
        sunHourAzimuth=sunPos.azimuth*180/Math.PI+180;

        //adjust azimuth if in southern hemisphere, TODO NEEDS TO BE FIXED
        if(latitude<0)
        {
          sunHourAzimuth=(sunHourAzimuth+180)%360
        }

        //draw the red circle/dots
        ctx.beginPath();
        ctx.arc(xCoord(sunHourAzimuth),yCoord(sunHourAltitude),3,0,2*Math.PI);
        ctx.strokeStyle = '#990000';
        ctx.stroke();
        ctx.closePath();

        //increment the moment object by an hour
        momentCounter.add(1,'h');
      }
    }



    //Sine and Cosine functions that take degrees as arguments.
    function sin(angle)
    {
      return Math.sin(Math.PI/180*angle);
    }
    function cos(angle)
    {
      return Math.cos(Math.PI/180*angle);
    }



    //Seeded Random Number generator
    //http://indiegamr.com/generate-repeatable-random-numbers-in-js/
    Math.seed=6;
    Math.seededRandom=function(max,min){
      max=max||1;
      min=min||0;

      Math.seed = (Math.seed * 9301 + 49297) % 233280;
      var rnd = Math.seed / 233280;
      return min + rnd * (max - min);
    }


    //TODO make stars vary with longitude
    function generateStars(timeAndDate,latitude,longitude,altitude,azimuth)
    {
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");


      var dec=[88,0];
      var hourDisplacement=[6,2];

      //generate random declination and hour displacements
      Math.seed=6;
      for(var count=0; count<120; count++)
      {

        dec.push(Math.seededRandom()*180-90);
        hourDisplacement.push(Math.seededRandom()*24);
      }

      //calculate star altitde and azimuth for every RNG based declination
      //and hour displacement in arrays.
      for(var i=0; i<dec.length;i++)
      {
        var hour=(timeAndDate.getHours()+timeAndDate.getMinutes()/60+hourDisplacement[i])%24;
        starAltitude=180/Math.PI*Math.asin(cos(latitude)*cos(hour*15)*cos(dec[i])+sin(latitude)*sin(dec[i]));
        starAzimuth=180/Math.PI*Math.acos((sin(starAltitude)*sin(latitude)-sin(dec[i]))/(cos(starAltitude)*cos(latitude)));

        //star azimuth adjustment
        if((hour*15)>180)
        {
          starAzimuth=360-starAzimuth;
        }
        starAzimuth=(starAzimuth+180)%360;


        //adjustment for southern hemisphere, TODO NEEDS TO BE FIXED
        if(latitude<0)
        {
            starAzimuth=(starAzimuth+180)%360;
        }

        //only draw stars with altitude above 0 degrees(above horizon)
        if(starAltitude>0)
        {
          ctx.beginPath();
          ctx.arc(xCoord(starAzimuth),yCoord(starAltitude),1,0,2*Math.PI);
          ctx.fillStyle = 'white';
          ctx.fill();
          ctx.closePath();
        }
      }
    }



    /*
    This function sets the drop down box dates and time to the current time
    in the given UTC zone.
    */
    function now()
    {
      var momentNow=moment().utcOffset(parseInt(document.getElementById("timezone").value),false);

      document.getElementById("month").value=momentNow.month()+1;
      handleMonthChange(false);
      document.getElementById("day").value=momentNow.date();
      document.getElementById("year").value=momentNow.year();

      var hour;
      if(checkClockType()=="12")
      {
        hour=momentNow.clone().format("h");
        var ampm=momentNow.clone().format("a").charAt(0);
        document.getElementById("ampm").value=ampm;
      }
      else {
        hour=momentNow.hour();
      }

      document.getElementById("hour").value=hour;
      document.getElementById("min").value=momentNow.minute();

      drawCanvas();
    }

    function playInitialize()
    {

      //var momentNow=moment();
      var month=document.getElementById("month").value;
      var day=document.getElementById("day").value;
      var year=document.getElementById("year").value;

      var momentCounter=moment(month+"/"+day+"/"+year+" 0","M/D/YYYY H").utcOffset(timezone,true);

      var playSecondInterval=120;
      play(momentCounter,playSecondInterval);
      //document.getElementById("playbutton").value="Stop";
    }

    function play(momentCounter, playSecondInterval)
    {
      if(checkClockType()=="12")
      {
        document.getElementById("hour").value=momentCounter.clone().format("h");
        document.getElementById("ampm").value=momentCounter.clone().format("a").charAt(0);
      }
      else {
        document.getElementById("hour").value=momentCounter.hour();
      }

      document.getElementById("min").value=momentCounter.minute();

      drawCanvas();

      momentCounter.add(playSecondInterval,"s");
      if(momentCounter.hour()!=23||momentCounter.minute()<(60-playSecondInterval/60))
      {
        setTimeout(play,30, momentCounter,playSecondInterval);
      }
    }

    function drawCanvas()
    {
      //grab vars from page
      var latDeg=document.getElementById("latDeg").value;
      var latMin=document.getElementById("latMin").value;
      var lonDeg=document.getElementById("lonDeg").value;
      var lonMin=document.getElementById("lonMin").value;
      var timezone=parseInt(document.getElementById("timezone").value);
      var day=document.getElementById("day").value;
      var month=document.getElementById("month").value;
      var year=document.getElementById("year").value;
      var vHemi=document.getElementById("vHemi").value;
      var hHemi=document.getElementById("hHemi").value;
      var hour=document.getElementById("hour").value;
      var min=document.getElementById("min").value;
      var ampm=document.getElementById("ampm").value;

      //calculate latitude from latitude grees and minutes
      var latitude=parseInt(latDeg)+latMin/60.0

      var longitude=parseInt(lonDeg)+lonMin/60.0

      var currentMoment;

      if(checkClockType()=="12")
      {
        currentMoment=moment(month+"/"+day+"/"+year+" "+hour+":"+min+" "+ampm+" "+timezone,"M/D/YYYY h:mm a");
      }
      else
      {
        currentMoment=moment(month+"/"+day+"/"+year+" "+hour+":"+min,"M/D/YYYY H:m");
      }

      currentMoment.utcOffset(timezone, true);


      //Convert latitude to negative if south was selected
      if(vHemi=="s")
      {
        latitude=-1*latitude;
      }

      //Convert longitude to negative if west was selected
      if(hHemi=="w")
      {
        longitude=-1*longitude;
      }



      //Calculate Current sun position
      //var currentTimeAndDate=new Date(year, month, day, hour, min);
      var currentTimeAndDate=currentMoment.clone().toDate();
      var currentSunPos=SunCalc.getPosition(/*Date*/ currentTimeAndDate, /*Number*/ latitude, /*Number*/ longitude);
      sunAltitude=currentSunPos.altitude*180/Math.PI;
      sunAzimuth=currentSunPos.azimuth*180/Math.PI+180;

      //adjustment for southern hemisphere
      if(latitude<0)
      {
        sunAzimuth=(sunAzimuth+180)%360;
      }

      //initialize canvas vars and clear
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");

      //draw sky color
      ctx.beginPath();
      var color="";
      var grad=ctx.createLinearGradient(xCoord(0),yCoord(90),xCoord(0),yCoord(0));
      if(sunAltitude<-18)
      {
        color="#301860";
        grad.addColorStop(0,"black");
        grad.addColorStop(1,color);
        ctx.fillStyle = grad;
      }
      else if(sunAltitude<-12)
      {
        color="#00344d"
        grad.addColorStop(0,"#301860");
        grad.addColorStop(1,color);
        ctx.fillStyle = grad;
      }
      else if(sunAltitude<-6)
      {
        color="#006999"
        grad.addColorStop(0,"#00344d");
        grad.addColorStop(1,color);
        ctx.fillStyle = grad;
      }
      else if(sunAltitude<0)
      {
        color="#4dc6ff"
        grad.addColorStop(0,"#006999");
        grad.addColorStop(1,color);
        ctx.fillStyle = grad;
      }
      else
      {
        color="#e6f7ff"
        grad.addColorStop(0,"#9adfff");
        grad.addColorStop(1,color);
        ctx.fillStyle = grad;
      }

      ctx.fillRect(xCoord(0),yCoord(0),xCoord(360),-90*c.height/120);
      ctx.closePath();

      //draw 10-80 degree altitude lines, in 10 degree increments
      for(var count=10; count<=80; count=count+10)
      {
        ctx.beginPath();
        ctx.moveTo(0,yCoord(count));
        ctx.lineTo(xCoord(360),yCoord(count));
        ctx.strokeStyle = '#555555';
        ctx.stroke();
        ctx.closePath();
      }

      //draw 180 degree azimith line
      ctx.beginPath();
      ctx.moveTo(xCoord(180),yCoord(0));
      ctx.lineTo(xCoord(180),yCoord(90));
      ctx.strokeStyle = '#800000';
      ctx.stroke();
      ctx.closePath();

      //draw 90 and 270 degree azimith line
      for(var i=90; i<=270; i+=180)
      {
        ctx.beginPath();
        ctx.moveTo(xCoord(i),yCoord(0));
        ctx.lineTo(xCoord(i),yCoord(90));
        ctx.strokeStyle = '#555555';
        ctx.stroke();
        ctx.closePath();
      }

      //draw -6 to 0 degree altitude twilight box
      ctx.beginPath();
      ctx.fillStyle ='#0099cc';
      ctx.fillRect(xCoord(0),yCoord(-6),xCoord(360),-6*c.height/120);
      ctx.closePath();

      //draw -12 to -6 degree altitude twilight box
      ctx.beginPath();
      ctx.fillStyle ='#003366';
      ctx.fillRect(xCoord(0),yCoord(-12),xCoord(360),-6*c.height/120);
      ctx.closePath();

      //draw -18 to -12 degree altitude twilight box
      ctx.beginPath();
      ctx.fillStyle ='#0e2f44';
      ctx.fillRect(xCoord(0),yCoord(-18),xCoord(360),-6*c.height/120);
      ctx.closePath();

      //draw -30 to -18 degree altitude night box
      ctx.beginPath();
      ctx.fillStyle ='#222222';
      ctx.fillRect(xCoord(0),yCoord(-30),xCoord(360),-12*c.height/120);
      ctx.closePath();

      //draw 0 altitude degree line
      ctx.beginPath();
      ctx.moveTo(0,yCoord(0));
      ctx.lineTo(xCoord(360),yCoord(0));
      ctx.strokeStyle = '#800000';
      ctx.stroke();
      ctx.closePath();

      //draw -18 to -6 degree altitude lines, in 6 degree increments
      for(var count=-18; count<=-6; count=count+6)
      {
        ctx.beginPath();
        ctx.moveTo(0,yCoord(count));
        ctx.lineTo(xCoord(360),yCoord(count));
        ctx.strokeStyle = '#800000';
        ctx.stroke();
        ctx.closePath();
      }

      //draw direction labels
      ctx.font = "14px Arial";
      ctx.fillStyle="#ffffff"
      ctx.fillText("South",c.width*.5,yCoord(90-5));
      ctx.font = "14px Arial";
      ctx.fillText("West",c.width*.75,yCoord(90-5));
      ctx.font = "14px Arial";
      ctx.fillText("East",c.width*.25,yCoord(90-5));

      //draw degree labels
      for(var count=10; count<=90; count=count+10)
      {
        ctx.font = "10px Arial";
        ctx.fillStyle="#ffffff"
        ctx.fillText(count+" deg",c.width*.95,yCoord(count-2));
      }

      //plot 24 points for each hour
      plotSunPoints(latitude,longitude,currentMoment);

      //draw sun
      ctx.beginPath();
      ctx.arc(xCoord(sunAzimuth),yCoord(sunAltitude),10,0,2*Math.PI);
      ctx.strokeStyle = '#990000';
      ctx.stroke();
      ctx.fillStyle = '#ffff00';
      ctx.fill();
      ctx.closePath();

      if(sunAltitude<-6)
      {
        generateStars(currentTimeAndDate, latitude, longitude, sunAltitude,sunAzimuth);
      }
      drawMoon(currentTimeAndDate,latitude, longitude);

      //draw border
      ctx.beginPath();
      ctx.strokeStyle = '#800000';
      ctx.strokeRect(0, 0, c.width, c.height);
      ctx.closePath();

      var sunTimes=SunCalc.getTimes(/*Date*/ currentTimeAndDate, /*Number*/ latitude, /*Number*/ longitude);
      var sunrise=moment(sunTimes.sunrise).utcOffset(timezone,false);
      var sunset=moment(sunTimes.sunset).utcOffset(timezone,false);
      var dayLength=sunset.diff(sunrise, 'minutes')/60.0;
      var sunriseStr;
      var sunsetStr;

      if(checkClockType()=="12")
      {
        sunriseStr=sunrise.format("h:mm a");
        sunsetStr=sunset.format("h:mm a");
      }
      else {
        sunriseStr=sunrise.format("H:mm");
        sunsetStr=sunset.format("H:mm");
      }


      var sunTimesString="Sunrise: "+sunriseStr+" Sunset: "+sunsetStr+" Day Length: "+dayLength;
      document.getElementById("infoPanel").innerHTML=sunTimesString;
    }
    </script>
  </head>
  <body>
    <h1>Unnamed App</h1>
    <p>Description</p>

    <!--location line-->
    Location:
    <select onchange="drawCanvas()" id="latDeg">
      <script>
        for(var i=0; i<=89;i++)
        {
          document.write('<option value="'+i+'">'+i+'</option>');
        }
      </script>
    </select>°
    <select onchange="drawCanvas()" id="latMin">
      <script>
        for(var i=0; i<=59;i++)
        {
          document.write('<option value="'+i+'">'+i+'</option>');
        }
      </script>
    </select>'
    <select onchange="drawCanvas()" id="vHemi">
      <option value="n">N</option>
      <option value="s">S</option>
    </select>
    <select onchange="drawCanvas()" id="lonDeg">
      <script>
        for(var i=0; i<=179;i++)
        {
          document.write('<option value="'+i+'">'+i+'</option>');
        }
      </script>
    </select>°
    <select onchange="drawCanvas()" id="lonMin">
      <script>
        for(var i=0; i<=59;i++)
        {
          document.write('<option value="'+i+'">'+i+'</option>');
        }
      </script>
    </select>'
    <select onchange="drawCanvas()" id="hHemi">
      <option value="w">W</option>
      <option value="e">E</option>
    </select>
    Timezone:
    <select onchange="now()" id="timezone">
      <script>
        for(var i=-12; i<=12;i++)
        {
          document.write('<option value="'+i+'">'+i+'</option>');
        }
      </script>
    </select>
    <br>

    <!--Date line-->
    Date:
    <select onchange="handleMonthChange(true)" id="month">
      <script>
        for(var i=1; i<=12;i++)
        {
          document.write('<option value="'+i+'">'+i+'</option>');
        }
      </script>
    </select>
    <select onchange="drawCanvas()" id="day">
    </select>
    <select onchange="drawCanvas()" id="year">
      <script>
        for(var i=1990; i<=2025;i++)
        {
          document.write('<option value="'+i+'">'+i+'</option>');
        }
      </script>
    </select>
      Time
    <select onchange="drawCanvas()" id="hour">
      <script>
          document.write('<option value="12">12</option>');
          for(var i=1; i<=11;i++)
          {
            document.write('<option value="'+i+'">'+i+'</option>');
          }
      </script>
    </select>
    <select onchange="drawCanvas()" id="min">
      <script>
        for(var i=0; i<=59;i++)
        {
          document.write('<option value="'+i+'">'+i+'</option>');
        }
      </script>
    </select>
    <select id="ampm" onchange="drawCanvas()">
      <option value="a">AM</option>
      <option value="p">PM</option>
    </select>
    <!--<button type="button" onclick="drawCanvas()">Update</button>-->
    <button type="button" onclick="now()">now</button>
    <button type="button" id="playbutton" onclick="playInitialize()">Play</button>
    <input type="radio" name="clockType" id="clockType12" value="12"  onclick="updateClockType()" checked>12hr
    <input type="radio" name="clockType" id="clockType24" value="24" onclick="updateClockType()" >24hr
    <p id="infoPanel">info panel</p>

    <canvas id="myCanvas" width="1200" height="600"></canvas>
    <script>
      tempStartLocation()
      now();
    </script>
    <br>

    <p>Copyright(c) Sargent McDermott. All Rights Reserved.</p>
  </body>
</html>
